#!/bin/bash

# ======================
#        JUMAWAN WEEWKING
# ======================
# DNS Dig Loop & Network Booster Script
# Version 1.0

RED='\033[0;31m'
NC='\033[0m'

NS_LIST=()
LOOP_DELAY=0
AUTORUN_FILE="$HOME/.dns_autodig_autorun"

declare -a HOSTS=(
    '124.6.181.31'
    '124.6.181.171'
    '124.6.181.26'
    '124.6.181.27'
    '124.6.181.25'
)

network_booster() {
    while true; do
        for host in "${HOSTS[@]}"; do
            ping -c 1 "${host}" >/dev/null &
        done
        wait
    done
}

check() {
    for host in "${HOSTS[@]}"; do
        for R in "${NS_LIST[@]}"; do
            if [ -z "$R" ]; then continue; fi
            if [ -z "$(dig "@${host}" "${R}")" ]; then
                echo -e "${RED}Failed - Querying: ${R} from ${host}${NC}"
            else
                echo -e "\e[32mSuccess - Querying: ${R} from ${host}${NC}"
            fi
        done
    done
}

start_dig_loop() {
    echo -e "${RED}Starting DNS Dig Loop...${NC}"
    network_booster &
    NETWORK_BOOSTER_PID=$!
    trap 'kill $NETWORK_BOOSTER_PID 2>/dev/null' 2 15
    while true; do
        check
        echo '-----------------------------------------'
        sleep "${LOOP_DELAY}"
    done
}

autorun_start() {
    termux-wake-lock
    echo -e "${RED}Autorun has been enabled.${NC}"
    echo "bash $PWD/$(basename "$0") &" > "$AUTORUN_FILE"
}

autorun_stop() {
    termux-wake-unlock
    echo -e "${RED}Autorun has been disabled.${NC}"
    rm -f "$AUTORUN_FILE"
}

autorun_status() {
    if [ -f "$AUTORUN_FILE" ]; then
        echo -e "${RED}Autorun is ENABLED.${NC}"
    else
        echo -e "${RED}Autorun is DISABLED.${NC}"
    fi
}

install_dnsutils() {
    echo -e "${RED}=============================${NC}"
    echo -e "${RED}    JUMAWAN WEEWKING MENU    ${NC}"
    echo -e "${RED}=============================${NC}"
    pkg install dnsutils -y
}

banner() {
    echo -e "${RED}=============================${NC}"
    echo -e "${RED}    JUMAWAN WEEWKING MENU    ${NC}"
    echo -e "${RED}=============================${NC}"
}

main_menu() {
    while true; do
        banner
        echo -e "[1] Add NS"
        echo -e "[2] Check NS"
        echo -e "[3] Delete NS"
        echo -e "[4] Start Dig Loop"
        echo -e "[5] Autorun Start"
        echo -e "[6] Autorun Stop"
        echo -e "[7] Autorun Status"
        echo -e "[8] Exit"
        echo -n "Choose an option: "
        read opt
        case $opt in
            1)
                echo -n "Enter NS: "
                read ns
                NS_LIST+=("$ns")
                ;;
            2)
                echo "NS List: ${NS_LIST[*]}"
                ;;
            3)
                echo "NS List: ${NS_LIST[*]}"
                echo -n "Enter NS to delete: "
                read ns_del
                NS_LIST=( "${NS_LIST[@]/$ns_del}" )
                ;;
            4)
                start_dig_loop
                ;;
            5)
                autorun_start
                ;;
            6)
                autorun_stop
                ;;
            7)
                autorun_status
                ;;
            8)
                echo -e "${RED}Exiting...${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid option.${NC}"
                ;;
        esac
    done
}

# Install dnsutils if not present
if ! command -v dig &> /dev/null; then
    install_dnsutils
fi

main_menu
